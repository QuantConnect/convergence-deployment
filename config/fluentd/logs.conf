<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

<filter docker.proxy docker.admin-console>
  @type parser
  key_name log
  reserve_data yes

  <parse>
    @type regexp
    expression /^(?<remote>[^ ]*) (?<host>[^ ]*) (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^\"]*) +\S*)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)" "(?<x>[^\"]*)")?$/
    time_format %d/%b/%Y:%H:%M:%S %z
    time_key time
  </parse>
</filter>

<filter docker.server-node docker.server-cluster-seed>
  @type parser
  key_name log
  reserve_data yes

  <parse>
    @type json
  </parse>
</filter>

<filter docker.kibana>
  @type parser
  key_name log
  reserve_data no

  <parse>
    @type json
    time_type string
    time_key time
    time_format %Y-%m-%d %H:%M:%S.%N %z
  </parse>
</filter>

<filter docker.server-node docker.server-cluster-seed>
  @type json_transform
  transform_script custom
  script_path "/fluentd/etc/transform_script.rb"
</filter>

<match docker.server-orientdb>
  @type rewrite_tag_filter
  capitalize_regex_backreference yes
  <rule>
    key log
    pattern ^\d{4}-\d{2}-\d{2}.*
    tag docker.server-orientdb.logger
  </rule>
  <rule>
    key log
    pattern .+
    tag docker.server-orientdb.console
  </rule>
</match>

<filter docker.server-orientdb.logger>
  @type parser
  key_name log
  reserve_data yes

  <parse>
    @type regexp
    expression /^(?<time>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}:\d{3}) (?<level>\S+) (?<message>.*) \[(?<class>\S+)\]$/
    time_format %Y-%m-%d %H:%M:%S:%L
    time_key time
  </parse>
</filter>

<filter docker.*.console>
  @type record_transformer
  enable_ruby
  <record>
    message ${record['log']}
  </record>
</filter>

<filter docker.**>
  @type record_transformer
  enable_ruby
  <record>
    timestamp ${ require 'time'; Time.now.utc.round(10).iso8601(6) }
  </record>
</filter>

<match **>
  @type elasticsearch
  include_tag_key true
  logstash_format true
  host "elasticsearch"
  port 9200
  type_name fluentd
  <buffer>
    flush_mode interval
    flush_interval 5s
  </buffer>
</match>
